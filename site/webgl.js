"use strict;";let LogLevel=function(){let _=Object.create(null);_.TRACE=0;_.INFO=1;_.WARNNG=2;_.ERROR=3;let logLevel=_.ERROR;_.set=function(newLogLevel){logLevel=newLogLevel};let formatStrings=["TRC","INF","WRN","ERR"];_.say=function(messageLogLevel,message){if(messageLogLevel>=logLevel){console.log(formatStrings[messageLogLevel]+": "+message)}};_.trace=function(message){this.say(_.TRACE,message)};_.info=function(message){this.say(_.INFO,message)};_.warn=function(message){this.say(_.WARNNG,message)};_.error=function(message){this.say(_.ERROR,message)};return _}();let OnReady=function(){let _=Object.create(null);_.construct=function(scope,callback){this.scope=scope;this.callback=callback;return this};_.notify=function(parameter){this.callback.call(this.scope,parameter)};_.new=function(scope,callback){return Object.create(_).construct(scope,callback)};return _}();"use strict;";let MouseTracker=function(){let _=Object.create(null);let mouseDownPosition;let bound;let onReady;let stepSize;let mousePosition=function(event){return{x:(event.clientX-bound.left)/bound.width,y:(event.clientY-bound.top)/bound.height}};let mouseMoved=function(event){let mouseMovedPosition=mousePosition(event);let deltaPosition=[mouseMovedPosition.x-mouseDownPosition.x,mouseMovedPosition.y-mouseDownPosition.y];mouseDownPosition=mouseMovedPosition;onReady.notify(deltaPosition)};let mouseUp=function(event){window.removeEventListener("mousemove",mouseMoved,false);window.removeEventListener("mouseup",mouseUp,false)};let mouseDown=function(event){mouseDownPosition=mousePosition(event);window.addEventListener("mousemove",mouseMoved,false);window.addEventListener("mouseup",mouseUp,false)};let KEY_LEFT=37;let KEY_RIGHT=39;let keyDown=function(event){switch(event.keyCode){case KEY_LEFT:onReady.notify([-stepSize,0]);break;case KEY_RIGHT:onReady.notify([stepSize,0]);break;default:onReady.notify([0,0]);break}};_.construct=function(canvasId,onReadyIn,stepSizeIn){onReady=onReadyIn;stepSize=typeof stepSizeIn!=="undefined"&&stepSizeIn!=null?stepSizeIn:.05;let canvas=document.getElementById(canvasId);bound=canvas.getBoundingClientRect();canvas.addEventListener("mousedown",mouseDown,false);canvas.addEventListener("keydown",keyDown,true);canvas.focus()};_.new=function(canvasId,onReadyIn,stepSizeIn){return Object.create(_).construct(canvasId,onReadyIn,stepSizeIn)};return _}();let Loader=function(){let _=Object.create(null);_.construct=function(parameters){this.onFinishedAll=typeof parameters.onFinishedAll!=="undefined"&&parameters.onFinishedAll!=null?parameters.onFinishedAll:{notify:function(x){}};this.onFinishedItem=typeof parameters.onFinishedItem!=="undefined"&&parameters.onFinishedItem!=null?parameters.onFinishedItem:{notify:function(x){}};this.items=[];return this};_.addItem=function(type,name,url,parameters){let item={type:type,name:name,url:url,parameters:parameters};this.items.push(item);return this};_.finish=function(finishedItem){if(finishedItem===this.pendingItem){delete this.pendingItem;this.onFinishedItem.notify(finishedItem);this.next()}else{}};_.go=function(onFinishedEach,onFinishedAll){this.onFinishedEach=typeof onFinishedEach!=="undefined"&&onFinishedEach!=null?onFinishedEach:{notify:function(x){}};this.onFinishedAll=typeof onFinishedAll!=="undefined"&&onFinishedAll!=null?onFinishedAll:{notify:function(x){}};this.next()};_.next=function(){if(this.items.length>0){let item=this.items.shift();this.pendingItem=item.type.new(item.name,item.url,item.parameters,OnReady.new(this,this.finish))}else{this.onFinishedAll.notify(this)}};_.new=function(parameters){return Object.create(_).construct(parameters)};return _}();let LoaderPath=function(){let _=Object.create(Loader);_.construct=function(parameters){Object.getPrototypeOf(_).construct.call(this,parameters);this.type=parameters.type;this.path=parameters.path;return this};_.addItems=function(names,parameters){names=Array.isArray(names)?names:Array(1).fill(names);for(let name of names){let url=this.path.replace("@",name);Object.getPrototypeOf(_).addItem.call(this,this.type,name,url,parameters)}return this};_.new=function(parameters){return Object.create(_).construct(parameters)};return _}();let LoaderShader=function(){let _=Object.create(LoaderPath);_.construct=function(path){return Object.getPrototypeOf(_).construct.call(this,{type:Shader,path:path})};let addNames=function(names,prefix){names=Array.isArray(names)?names:Array(1).fill(names);let result=[];for(let name of names){result.push(prefix+"-"+name)}return result};_.addVertexShaders=function(names){return Object.getPrototypeOf(_).addItems.call(this,addNames(names,"vertex"),{type:context.VERTEX_SHADER})};_.addFragmentShaders=function(names){return Object.getPrototypeOf(_).addItems.call(this,addNames(names,"fragment"),{type:context.FRAGMENT_SHADER})};_.new=function(path){return Object.create(_).construct(path)};return _}();let context;let Render=function(){let _=Object.create(null);_.construct=function(canvasId,aspectRatio){let canvas=this.canvas=document.getElementById(canvasId);aspectRatio=typeof aspectRatio!=="undefined"&&aspectRatio!=null?aspectRatio:16/9;let width=canvas.width;let height=width/aspectRatio;canvas.style.width=width+"px";canvas.style.height=height+"px";let devicePixelRatio=window.devicePixelRatio||1;canvas.width=width*devicePixelRatio;canvas.height=height*devicePixelRatio;context=this.context=canvas.getContext("webgl",{preserveDrawingBuffer:true,alpha:false});context.viewportWidth=canvas.width;context.viewportHeight=canvas.height;context.viewport(0,0,context.viewportWidth,context.viewportHeight);Tetrahedron.make();Hexahedron.make();Octahedron.make();Icosahedron.make();Square.make();Sphere.makeN(2);Sphere.makeN(3);Sphere.makeN(5);return this};_.use=function(){context=this.context};_.new=function(canvasId,aspectRatio){return render=Object.create(_).construct(canvasId,aspectRatio)};return _}();let glMatrixArrayType=typeof Float32Array!="undefined"?Float32Array:typeof WebGLFloatArray!="undefined"?WebGLFloatArray:Array;let FloatN=function(dim){let _=Object.create(null);_.create=function(){return new glMatrixArrayType(dim)};eval(function(){let str="_.copy = function (from, to) { ";str+="to = (typeof to !== 'undefined') ? to : _.create (); ";for(let i=0;i<dim;++i){str+="to["+i+"] = from["+i+"]; "}str+="return to; ";str+="}; ";return str}());eval(function(){let str="_.point = function (from, to) {";str+="to = (typeof to !== 'undefined') ? to : _.create (); ";let end=dim-1;for(let i=0;i<end;++i){str+="to["+i+"] = from["+i+"]; "}str+="to["+end+"] = 1; ";str+="return to; ";str+="}; ";return str}());eval(function(){let str="_.vector = function (from, to) {";str+="to = (typeof to !== 'undefined') ? to : _.create (); ";let end=dim-1;for(let i=0;i<end;++i){str+="to["+i+"] = from["+i+"]; "}str+="to["+end+"] = 0; ";str+="return to; ";str+="}; ";return str}());eval(function(){let str="_.dot = function (left, right) {";str+="return (left[0] * right[0])";for(let i=1;i<dim;++i){str+=" + (left["+i+"] * right["+i+"])"}str+="; ";str+="}; ";return str}());_.normSq=function(from){return _.dot(from,from)};_.norm=function(from){let n2=_.normSq(from);return n2>0?Math.abs(n2-1)>1e-6?Math.sqrt(n2):1:0};_.normalize=function(from,to){let n=_.norm(from);return Math.abs(n-1)>1e-6?_.scale(from,1/n,to):_.copy(from)};eval(function(){let str="_.add = function (left, right, to) {";str+="to = (typeof to !== 'undefined') ? to : _.create (); ";for(let i=0;i<dim;++i){str+="to["+i+"] = left["+i+"] + right["+i+"]; "}str+="return to; ";str+="}; ";return str}());eval(function(){let str="_.subtract = function (left, right, to) {\n";str+="to = (typeof to !== 'undefined') ? to : _.create ();\n";for(let i=0;i<dim;++i){str+="to["+i+"] = left["+i+"] - right["+i+"]; "}str+="\n";str+="return to;\n";str+="};\n";return str}());eval(function(){let str="_.scale = function (from, scale, to) {";str+="to = (typeof to !== 'undefined') ? to : _.create (); ";for(let i=0;i<dim;++i){str+="to["+i+"] = from["+i+"] * scale; "}str+="return to; ";str+="}; ";return str}());eval(function(){let str="_.fixNum = function (from, precision, to) {";str+="to = (typeof to !== 'undefined') ? to : _.create (); ";for(let i=0;i<dim;++i){str+="to["+i+"] = Utility.fixNum (from["+i+"], precision); "}str+="return to; ";str+="}; ";return str}());eval(function(){let str="_.minor = function (from) {\n";str+="let minorIndex = 0, minorValue = from[minorIndex];\n";for(let i=1;i<dim;++i){str+="nextValue = from["+i+"]; ";str+="if (minorValue > nextValue) { minorIndex = "+i+"; minorValue = nextValue;}; "}str+="return minorIndex;\n";str+="};\n";return str}());eval(function(){let str="_.major = function (from) {\n";str+="let majorIndex = 0, majorValue = from[majorIndex];\n";for(let i=1;i<dim;++i){str+="nextValue = from["+i+"]; ";str+="if (majorValue < nextValue) { majorIndex = "+i+"; majorValue = nextValue;}; "}str+="return majorIndex;\n";str+="};\n";return str}());eval(function(){let str="_.str = function (from) {";str+="return '(' + from[0]";for(let i=1;i<dim;++i){str+=" + ', ' +  + from["+i+"].toFixed (7)"}str+=" + ')'; ";str+="}; ";return str}());_.equals=function(left,right){return _.str(left)==_.str(right)};return _};let Float2=function(){let _=FloatN(2);_.perpendicular=function(from,to){to=typeof to!=="undefined"&&to!=null?to:_.create();to[0]=from[1];to[1]=-from[0];return to};_.cross=function(left,right){return left[0]*right[1]-left[1]*right[0]};return _}();let Float3=function(){let _=FloatN(3);_.cross=function(left,right,to){to=typeof to!=="undefined"&&to!=null?to:_.create();to[0]=left[1]*right[2]-left[2]*right[1];to[1]=left[2]*right[0]-left[0]*right[2];to[2]=left[0]*right[1]-left[1]*right[0];return to};return _}();let Float4=function(){let _=FloatN(4);return _}();let FloatNxN=function(dim){let _=Object.create(null);let _FloatN=FloatN(dim);let size=dim*dim;let index=_.index=function(row,column){return row*dim+column};let defineTo=function(to){to=typeof to!=="undefined"&&to!=null?to:"to";return to+" = (typeof "+to+" !== 'undefined') ? "+to+" : _.create ();\n"};_.create=function(){return new glMatrixArrayType(size)};eval(function(){let str="_.copy = function (from, to) {\n";str+=defineTo();for(let row=0;row<dim;++row){for(let col=0;col<dim;++col){let i=index(row,col);str+="to["+i+"] = from["+i+"]; "}str+="\n"}str+="return to;\n";str+="};\n";return str}());eval(function(){let str="_.identity = function (to) {\n";str+=defineTo();for(let row=0;row<dim;++row){for(let column=0;column<dim;++column){str+="to["+index(row,column)+"] = "+(row==column?1:0)+"; "}str+="\n"}str+="return to;\n";str+="};\n";return str}());eval(function(){let str="_.transpose = function (from, to) {\n";str+=defineTo();for(let row=0;row<dim;++row){for(let column=0;column<dim;++column){str+="to["+index(row,column)+"] = from["+index(column,row)+"]; "}str+="\n"}str+="return to;\n";str+="};\n";return str}());eval(function(){let rc=function(r,c){let str="(left["+index(r,0)+"] * right["+index(0,c)+"])";for(let i=1;i<dim;++i){str+=" + (left["+index(r,i)+"] * right["+index(i,c)+"])"}str+=";\n";return str};let str="_.multiply = function (left, right, to) {\n";str+=defineTo();for(let row=0;row<dim;++row){for(let column=0;column<dim;++column){str+="to["+index(row,column)+"] = "+rc(row,column)}}str+="return to;\n";str+="};\n";return str}());_.chain=function(...args){let result=args[0];for(let index=1,end=args.length;index<end;++index){let next=args[index];result=_.multiply(result,next)}return result};eval(function(){let end=dim-1;let str="_.scale = function (scale, to) {\n";str+="scale = Array.isArray(scale) ? scale : Array("+end+").fill(scale);\n";str+="to = _.identity (to);\n";for(let i=0;i<end;++i){str+="to["+index(i,i)+"] = scale["+i+"]; "}str+="\n";str+="return to;\n";str+="};\n";return str}());eval(function(){let end=dim-1;let str="_.translate = function (translate, to) {\n";str+="to = _.identity (to);\n";for(let i=0;i<end;++i){str+="to["+index(end,i)+"] = translate["+i+"]; "}str+="\n";str+="return to;\n";str+="};\n";return str}());eval(function(){let strRow=function(row){let str="'(' + from["+index(row,0)+"]";for(let column=1;column<dim;++column){str+=" + ', ' + from["+index(row,column)+"]"}str+=" + ')'";return str};let str="_.str = function (from) {\n";str+="return ";str+=strRow(0);for(let row=1;row<dim;++row){str+=" + ', ' + "+strRow(row)}str+=";\n";str+="};\n";return str}());return _};let Float4x4=function(){let dim=4;let _=FloatNxN(dim);_.inverse=function(from,to){to=typeof to!=="undefined"&&to!=null?to:_.create();let A=from[0]*from[5]-from[1]*from[4],B=from[0]*from[6]-from[2]*from[4],C=from[9]*from[14]-from[10]*from[13],D=from[9]*from[15]-from[11]*from[13],E=from[10]*from[15]-from[11]*from[14],F=from[0]*from[7]-from[3]*from[4],G=from[1]*from[6]-from[2]*from[5],H=from[1]*from[7]-from[3]*from[5],K=from[2]*from[7]-from[3]*from[6],L=from[8]*from[13]-from[9]*from[12],M=from[8]*from[14]-from[10]*from[12],N=from[8]*from[15]-from[11]*from[12],Q=1/(A*E-B*D+F*C+G*N-H*M+K*L);to[0]=(from[5]*E-from[6]*D+from[7]*C)*Q;to[1]=(-from[1]*E+from[2]*D-from[3]*C)*Q;to[2]=(from[13]*K-from[14]*H+from[15]*G)*Q;to[3]=(-from[9]*K+from[10]*H-from[11]*G)*Q;to[4]=(-from[4]*E+from[6]*N-from[7]*M)*Q;to[5]=(from[0]*E-from[2]*N+from[3]*M)*Q;to[6]=(-from[12]*K+from[14]*F-from[15]*B)*Q;to[7]=(from[8]*K-from[10]*F+from[11]*B)*Q;to[8]=(from[4]*D-from[5]*N+from[7]*L)*Q;to[9]=(-from[0]*D+from[1]*N-from[3]*L)*Q;to[10]=(from[12]*H-from[13]*F+from[15]*A)*Q;to[11]=(-from[8]*H+from[9]*F-from[11]*A)*Q;to[12]=(-from[4]*C+from[5]*M-from[6]*L)*Q;to[13]=(from[0]*C-from[1]*M+from[2]*L)*Q;to[14]=(-from[12]*G+from[13]*B-from[14]*A)*Q;to[15]=(from[8]*G-from[9]*B+from[10]*A)*Q;return to};_.preMultiply=function(f4,f4x4,to){to=typeof to!=="undefined"&&to!=null?to:Float4.create();let f40=f4[0],f41=f4[1],f42=f4[2],f43=f4[3];to[0]=f4x4[0]*f40+f4x4[4]*f41+f4x4[8]*f42+f4x4[12]*f43;to[1]=f4x4[1]*f40+f4x4[5]*f41+f4x4[9]*f42+f4x4[13]*f43;to[2]=f4x4[2]*f40+f4x4[6]*f41+f4x4[10]*f42+f4x4[14]*f43;to[3]=f4x4[3]*f40+f4x4[7]*f41+f4x4[11]*f42+f4x4[15]*f43;return to};_.postMultiply=function(f4x4,f4,to){to=typeof to!=="undefined"&&to!=null?to:Float4.create();let f40=f4[0],f41=f4[1],f42=f4[2],f43=f4[3];to[0]=f4x4[0]*f40+f4x4[1]*f41+f4x4[2]*f42+f4x4[3]*f43;to[1]=f4x4[4]*f40+f4x4[5]*f41+f4x4[6]*f42+f4x4[7]*f43;to[2]=f4x4[8]*f40+f4x4[9]*f41+f4x4[10]*f42+f4x4[11]*f43;to[3]=f4x4[12]*f40+f4x4[13]*f41+f4x4[14]*f42+f4x4[15]*f43;return to};_.rotateX=function(angle){let to=_.identity();to[5]=to[10]=Math.cos(angle);to[9]=-(to[6]=Math.sin(angle));return to};_.rotateY=function(angle){let to=_.identity();to[0]=to[10]=Math.cos(angle);to[2]=-(to[8]=Math.sin(angle));return to};_.rotateZ=function(angle){let to=_.identity();to[0]=to[5]=Math.cos(angle);to[4]=-(to[1]=Math.sin(angle));return to};let frustum=function(left,right,bottom,top,near,far,to){to=typeof to!=="undefined"&&to!=null?to:_.create();let width=right-left,height=top-bottom,depth=far-near;to[0]=near*2/width;to[1]=0;to[2]=0;to[3]=0;to[4]=0;to[5]=near*2/height;to[6]=0;to[7]=0;to[8]=(right+left)/width;to[9]=(top+bottom)/height;to[10]=-(far+near)/depth;to[11]=-1;to[12]=0;to[13]=0;to[14]=-2*far*near/depth;to[15]=0;return to};_.frustum=frustum;_.perspective=function(fov,aspectRatio,nearPlane,farPlane,to){let halfWidth=nearPlane*Math.tan(Utility.degreesToRadians(fov*.5));let halfHeight=halfWidth*aspectRatio;return frustum(-halfHeight,halfHeight,-halfWidth,halfWidth,nearPlane,farPlane,to)};_.orthographic=function(left,right,bottom,top,near,far,to){to=typeof to!=="undefined"&&to!=null?to:_.create();let width=right-left,height=top-bottom,depth=far-near;to[0]=2/width;to[1]=0;to[2]=0;to[3]=0;to[4]=0;to[5]=2/height;to[6]=0;to[7]=0;to[8]=0;to[9]=0;to[10]=-2/depth;to[11]=0;to[12]=-(left+right)/width;to[13]=-(top+bottom)/height;to[14]=-(far+near)/depth;to[15]=1;return to};let viewMatrix=function(xAxis,yAxis,zAxis,from){let to=_.create();to[0]=xAxis[0];to[1]=xAxis[1];to[2]=xAxis[2];to[3]=0;to[4]=yAxis[0];to[5]=yAxis[1];to[6]=yAxis[2];to[7]=0;to[8]=zAxis[0];to[9]=zAxis[1];to[10]=zAxis[2];to[11]=0;to[12]=from[0];to[13]=from[1];to[14]=from[2];to[15]=1;return _.inverse(to)};_.viewMatrix=viewMatrix;let lookFrom=function(from,along,up){up=Float3.normalize(Utility.defaultValue(up,[0,1,0]));let zAxis=Float3.normalize(along);let xAxis=Float3.cross(up,zAxis);let yAxis=Float3.cross(zAxis,xAxis);return viewMatrix(xAxis,yAxis,zAxis,from)};_.lookFrom=lookFrom;_.lookFromAt=function(from,at,up){return lookFrom(Float3.subtract(from,at))};_.lookAt=function(size,fov,along,at,up){let distance=size/Math.tan(Utility.degreesToRadians(fov*.5));let from=Float3.add(at,Float3.scale(along,distance/Float3.norm(along)));return lookFrom(from,along,up)};_.rotateZAxisTo=function(zAxis,up){up=Utility.defaultFunction(up,function(){return[0,1,0]});zAxis=Float3.normalize(zAxis);let xAxis=Float3.normalize(Float3.cross(up,zAxis));let yAxis=Float3.cross(zAxis,xAxis);let to=_.create();to[0]=xAxis[0];to[1]=xAxis[1];to[2]=xAxis[2];to[3]=0;to[4]=yAxis[0];to[5]=yAxis[1];to[6]=yAxis[2];to[7]=0;to[8]=zAxis[0];to[9]=zAxis[1];to[10]=zAxis[2];to[11]=0;to[12]=0;to[13]=0;to[14]=0;to[15]=1;return to};_.rotateXAxisTo=function(xAxis,up){up=Utility.defaultFunction(up,function(){return[0,1,0]});xAxis=Float3.normalize(xAxis);let zAxis=Float3.normalize(Float3.cross(xAxis,up));let yAxis=Float3.cross(zAxis,xAxis);let to=_.create();to[0]=xAxis[0];to[1]=xAxis[1];to[2]=xAxis[2];to[3]=0;to[4]=yAxis[0];to[5]=yAxis[1];to[6]=yAxis[2];to[7]=0;to[8]=zAxis[0];to[9]=zAxis[1];to[10]=zAxis[2];to[11]=0;to[12]=0;to[13]=0;to[14]=0;to[15]=1;return to};return _}();let Shader=function(){let _=Object.create(null);let shaders=Object.create(null);_.construct=function(name,url,parameters,onReady){this.name=name;let scope=this;let request=new XMLHttpRequest;request.onload=function(event){if(request.status===200){let shader=context.createShader(parameters.type);context.shaderSource(shader,request.responseText);context.compileShader(shader);if(!context.getShaderParameter(shader,context.COMPILE_STATUS)){}else{scope.compiledShader=shader;onReady.notify(scope)}}};request.open("GET",url);request.send();return this};_.new=function(name,url,parameters,onReady){parameters=typeof parameters!=="undefined"&&parameters!=null?parameters:{};return shaders[name]=Object.create(_).construct(name,url,parameters,onReady)};_.get=function(name){return shaders[name]};return _}();let Program=function(){let _=Object.create(null);_.POSITION_ATTRIBUTE="POSITION_ATTRIBUTE";_.NORMAL_ATTRIBUTE="NORMAL_ATTRIBUTE";_.TEXTURE_ATTRIBUTE="TEXTURE_ATTRIBUTE";let programs=Object.create(null);let currentProgram;_.construct=function(name,parameters){this.name=name;this.currentShape=null;let program=this.program=context.createProgram();context.attachShader(program,Shader.get(parameters.vertexShader).compiledShader);context.attachShader(program,Shader.get(parameters.fragmentShader).compiledShader);context.bindAttribLocation(program,0,parameters.attributeMapping.POSITION_ATTRIBUTE);context.linkProgram(program);if(!context.getProgramParameter(program,context.LINK_STATUS)){}context.useProgram(program);let parameterMapping=parameters.parameterMapping;let reverseParameterMapping=Utility.reverseMap(parameterMapping);let standardParameterMapping=this.standardParameterMapping=Object.create(null);for(let i=0,end=context.getProgramParameter(program,context.ACTIVE_UNIFORMS);i<end;i++){let programUniform=ProgramUniform.new(program,i);let programUniformName=programUniform.name;let setProgramUniformFunctionName="set"+Utility.uppercase(programUniformName);this[setProgramUniformFunctionName]=function(value){programUniform.set(value);return this};if(programUniformName in reverseParameterMapping){standardParameterMapping[reverseParameterMapping[programUniformName]]=setProgramUniformFunctionName}}let reverseAttributeMapping=Utility.reverseMap(parameters.attributeMapping);let attributes=this.attributes=Object.create(null);for(let i=0,end=context.getProgramParameter(program,context.ACTIVE_ATTRIBUTES);i<end;i++){let activeAttribute=context.getActiveAttrib(program,i);let activeAttributeName=activeAttribute.name;if(activeAttributeName in reverseAttributeMapping){attributes[reverseAttributeMapping[activeAttributeName]]=ProgramAttribute.new(program,activeAttribute)}}return this};_.setStandardUniforms=function(parameters){let standardParameterMapping=this.standardParameterMapping;for(let parameter in parameters){if(parameter in standardParameterMapping){this[standardParameterMapping[parameter]](parameters[parameter])}}return this};let bindAttribute=function(scope,which,buffer){if(which in scope.attributes){context.bindBuffer(context.ARRAY_BUFFER,buffer);scope.attributes[which].bind()}return scope};_.bindPositionAttribute=function(buffer){return bindAttribute(this,_.POSITION_ATTRIBUTE,buffer)};_.bindNormalAttribute=function(buffer){return bindAttribute(this,_.NORMAL_ATTRIBUTE,buffer)};_.bindTextureAttribute=function(buffer){return bindAttribute(this,_.TEXTURE_ATTRIBUTE,buffer)};_.unbindAttributes=function(){for(let attribute in this.attributes){this.attributes[attribute].unbind()}};_.getCurrentProgram=function(){return currentProgram};_.use=function(){if(currentProgram!==this){if(currentProgram){currentProgram.unbindAttributes()}currentProgram=this;context.useProgram(this.program);this.currentShape=null}return this};_.useShape=function(shape){if(this.currentShape!==shape){this.currentShape=shape;return true}return false};_.getName=function(){return this.name};_.new=function(name,parameters){parameters=typeof parameters!=="undefined"&&parameters!=null?parameters:function(){return Object.create(null)}();parameters.vertexShader="vertex-"+(typeof parameters.vertexShader!=="undefined"&&parameters.vertexShader!=null?parameters.vertexShader:name);parameters.fragmentShader="fragment-"+(typeof parameters.fragmentShader!=="undefined"&&parameters.fragmentShader!=null?parameters.fragmentShader:name);if(!("attributeMapping"in parameters)){parameters.attributeMapping={POSITION_ATTRIBUTE:"inputPosition",NORMAL_ATTRIBUTE:"inputNormal",TEXTURE_ATTRIBUTE:"inputTexture"}}if(!("parameterMapping"in parameters)){parameters.parameterMapping={MODEL_MATRIX_PARAMETER:"modelMatrix",VIEW_MATRIX_PARAMETER:"viewMatrix",PROJECTION_MATRIX_PARAMETER:"projectionMatrix",NORMAL_MATRIX_PARAMETER:"normalMatrix",CAMERA_POSITION:"cameraPosition",OUTPUT_ALPHA_PARAMETER:"outputAlpha",TEXTURE_SAMPLER:"textureSampler",MODEL_COLOR:"modelColor",AMBIENT_LIGHT_COLOR:"ambientLightColor",AMBIENT_CONTRIBUTION:"ambientContribution",LIGHT_DIRECTION:"lightDirection",LIGHT_COLOR:"lightColor",DIFFUSE_CONTRIBUTION:"diffuseContribution",SPECULAR_CONTRIBUTION:"specularContribution",SPECULAR_EXPONENT:"specularExponent"}}return programs[name]=Object.create(_).construct(name,parameters)};_.get=function(name){return programs[name]};return _}();let ProgramUniform=function(){let _=Object.create(null);_.construct=function(program,i){let activeUniform=context.getActiveUniform(program,i);this.name=activeUniform.name;this.type=activeUniform.type;this.location=context.getUniformLocation(program,activeUniform.name);if(this.type==context.SAMPLER_2D){this.textureIndex="nextTextureIndex"in program?program.nextTextureIndex:0;program.nextTextureIndex=this.textureIndex+1}else{}return this};_.set=function(value){switch(this.type){case 5124:context.uniform1i(this.location,value);break;case 35667:context.uniform2iv(this.location,value);break;case 35668:context.uniform3iv(this.location,value);break;case 35669:context.uniform4iv(this.location,value);break;case 5126:context.uniform1f(this.location,value);break;case 35664:context.uniform2fv(this.location,value);break;case 35665:context.uniform3fv(this.location,value);break;case 35666:context.uniform4fv(this.location,value);break;case 35674:context.uniformMatrix2fv(this.location,false,value);break;case 35675:context.uniformMatrix3fv(this.location,false,value);break;case 35676:context.uniformMatrix4fv(this.location,false,value);break;case 35678:context.activeTexture(context.TEXTURE0+this.textureIndex);context.bindTexture(context.TEXTURE_2D,Texture.get(value).texture);context.uniform1i(this.location,this.textureIndex);break}};_.new=function(program,i){return Object.create(_).construct(program,i)};return _}();let ProgramAttribute=function(){let _=Object.create(null);_.construct=function(program,activeAttribute){this.name=activeAttribute.name;this.type=activeAttribute.type;this.location=context.getAttribLocation(program,this.name);switch(this.type){case 5124:this.bind=function(){context.enableVertexAttribArray(this.location);context.vertexAttribPointer(this.location,1,context.INT,false,0,0)};break;case 35667:this.bind=function(){context.enableVertexAttribArray(this.location);context.vertexAttribPointer(this.location,2,context.INT,false,0,0)};break;case 35668:this.bind=function(){context.enableVertexAttribArray(this.location);context.vertexAttribPointer(this.location,3,context.INT,false,0,0)};break;case 35669:this.bind=function(){context.enableVertexAttribArray(this.location);context.vertexAttribPointer(this.location,4,context.INT,false,0,0)};break;case 5126:this.bind=function(){context.enableVertexAttribArray(this.location);context.vertexAttribPointer(this.location,1,context.FLOAT,false,0,0)};break;case 35664:this.bind=function(){context.enableVertexAttribArray(this.location);context.vertexAttribPointer(this.location,2,context.FLOAT,false,0,0)};break;case 35665:this.bind=function(){context.enableVertexAttribArray(this.location);context.vertexAttribPointer(this.location,3,context.FLOAT,false,0,0)};break;case 35666:this.bind=function(){context.enableVertexAttribArray(this.location);context.vertexAttribPointer(this.location,4,context.FLOAT,false,0,0)};break}return this};_.unbind=function(){context.disableVertexAttribArray(this.location)};_.new=function(program,activeAttribute){return Object.create(_).construct(program,activeAttribute)};return _}();let Texture=function(){let _=Object.create(null);let textures=Object.create(null);let afExtension;_.construct=function(name,url,parameters,onReady){this.name=name;let texture=this.texture=context.createTexture();let image=new Image;image.crossOrigin="anonymous";let scope=this;image.onload=function(){context.bindTexture(context.TEXTURE_2D,texture);context.texImage2D(context.TEXTURE_2D,0,context.RGBA,context.RGBA,context.UNSIGNED_BYTE,image);context.texParameteri(context.TEXTURE_2D,context.TEXTURE_MAG_FILTER,context.LINEAR);if("generateMipMap"in parameters&&parameters.generateMipMap==true){context.texParameteri(context.TEXTURE_2D,context.TEXTURE_MIN_FILTER,context.LINEAR_MIPMAP_LINEAR);context.texParameterf(context.TEXTURE_2D,afExtension.TEXTURE_MAX_ANISOTROPY_EXT,parameters.anisotropicFiltering);context.generateMipmap(context.TEXTURE_2D)}else{context.texParameteri(context.TEXTURE_2D,context.TEXTURE_MIN_FILTER,context.LINEAR)}context.bindTexture(context.TEXTURE_2D,null);textures[name]=scope;onReady.notify(scope)};image.src=url;return this};_.new=function(name,url,parameters,onReady){afExtension=typeof afExtension!=="undefined"&&afExtension!=null?afExtension:function(){return context.getExtension("EXT_texture_filter_anisotropic")}();parameters=typeof parameters!=="undefined"&&parameters!=null?parameters:{};parameters.anisotropicFiltering=Math.min(context.getParameter(afExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT),"anisotropicFiltering"in parameters?parameters.anisotropicFiltering:4);return Object.create(_).construct(name,url,parameters,onReady)};_.get=function(name){if(name in textures){return textures[name]}};return _}();let Node=function(){let _=Object.create(null);let nodes=Object.create(null);_.construct=function(parameters){let HAS_TRANSFORM=1;let HAS_STATE=2;let HAS_SHAPE=4;let HAS_CHILDREN=8;let traverseFunctionIndex=0;if(typeof parameters!=="undefined"){if("name"in parameters){this.name=parameters.name;nodes[this.name]=this}if("transform"in parameters){this.transform=parameters.transform;traverseFunctionIndex+=HAS_TRANSFORM}if("state"in parameters){this.state=parameters.state;traverseFunctionIndex+=HAS_STATE}if("shape"in parameters){this.shape=Shape.get(parameters.shape);traverseFunctionIndex+=HAS_SHAPE}this.enabled=typeof parameters.enabled!=="undefined"&&parameters.enabled!=null?parameters.enabled:true;if(!("children"in parameters)||parameters.children!=false){this.children=[];traverseFunctionIndex+=HAS_CHILDREN}}else{this.children=[];traverseFunctionIndex+=HAS_CHILDREN}let INVALID_TRAVERSE=function(transform){return this};this.traverse=[INVALID_TRAVERSE,INVALID_TRAVERSE,INVALID_TRAVERSE,INVALID_TRAVERSE,function(standardUniforms){if(this.enabled){this.draw(standardUniforms)}return this},function(standardUniforms){if(this.enabled){standardUniforms.MODEL_MATRIX_PARAMETER=Float4x4.multiply(this.transform,standardUniforms.MODEL_MATRIX_PARAMETER);this.draw(standardUniforms)}return this},function(standardUniforms){if(this.enabled){this.state(standardUniforms);this.draw(standardUniforms)}return this},function(standardUniforms){if(this.enabled){this.state(standardUniforms);standardUniforms.MODEL_MATRIX_PARAMETER=Float4x4.multiply(this.transform,standardUniforms.MODEL_MATRIX_PARAMETER);this.draw(standardUniforms)}return this},function(standardUniforms){if(this.enabled){let modelMatrix=standardUniforms.MODEL_MATRIX_PARAMETER;for(let child of this.children){standardUniforms.MODEL_MATRIX_PARAMETER=modelMatrix;child.traverse(standardUniforms)}}return this},function(standardUniforms){if(this.enabled){let modelMatrix=Float4x4.multiply(this.transform,standardUniforms.MODEL_MATRIX_PARAMETER);for(let child of this.children){standardUniforms.MODEL_MATRIX_PARAMETER=modelMatrix;child.traverse(standardUniforms)}}return this},function(standardUniforms){if(this.enabled){this.state(standardUniforms);let modelMatrix=standardUniforms.MODEL_MATRIX_PARAMETER;for(let child of this.children){standardUniforms.MODEL_MATRIX_PARAMETER=modelMatrix;child.traverse(standardUniforms)}}return this},function(standardUniforms){if(this.enabled){this.state(standardUniforms);let modelMatrix=Float4x4.multiply(this.transform,standardUniforms.MODEL_MATRIX_PARAMETER);for(let child of this.children){standardUniforms.MODEL_MATRIX_PARAMETER=modelMatrix;child.traverse(standardUniforms)}}return this},function(standardUniforms){if(this.enabled){let modelMatrix=standardUniforms.MODEL_MATRIX_PARAMETER;this.draw(standardUniforms);for(let child of this.children){standardUniforms.MODEL_MATRIX_PARAMETER=modelMatrix;child.traverse(standardUniforms)}}return this},function(standardUniforms){if(this.enabled){let modelMatrix=standardUniforms.MODEL_MATRIX_PARAMETER=Float4x4.multiply(this.transform,standardUniforms.MODEL_MATRIX_PARAMETER);this.draw(standardUniforms);for(let child of this.children){standardUniforms.MODEL_MATRIX_PARAMETER=modelMatrix;child.traverse(standardUniforms)}}return this},function(standardUniforms){if(this.enabled){this.state(standardUniforms);this.draw(standardUniforms);let modelMatrix=standardUniforms.MODEL_MATRIX_PARAMETER;for(let child of this.children){standardUniforms.MODEL_MATRIX_PARAMETER=modelMatrix;child.traverse(standardUniforms)}}return this},function(standardUniforms){if(this.enabled){this.state(standardUniforms);let modelMatrix=standardUniforms.MODEL_MATRIX_PARAMETER=Float4x4.multiply(this.transform,standardUniforms.MODEL_MATRIX_PARAMETER);this.draw(standardUniforms);for(let child of this.children){standardUniforms.MODEL_MATRIX_PARAMETER=modelMatrix;child.traverse(standardUniforms)}}return this}][traverseFunctionIndex];return this};_.addChild=function(node){if("children"in this){this.children.push(node);node.parent=this}else{}return this};_.draw=function(standardUniforms){standardUniforms.NORMAL_MATRIX_PARAMETER=Float4x4.transpose(Float4x4.inverse(standardUniforms.MODEL_MATRIX_PARAMETER));Program.getCurrentProgram().setStandardUniforms(standardUniforms);this.shape.draw()};_.traverse=function(standardUniforms){return this};_.getTransform=function(root){let transform="transform"in this?this.transform:Float4x4.identity();if(this==root){return transform}else{
return Float4x4.multiply(transform,this.parent.getTransform(root))}};_.getName=function(){return"name"in this?this.name:"node"};_.get=function(name){return nodes[name]};_.new=function(parameters){return Object.create(_).construct(parameters)};return _}();let Cloud=function(){let _=Object.create(Node);_.construct=function(parameters){Object.getPrototypeOf(_).construct.call(this,parameters);this.pointShape="pointShape"in parameters?parameters.pointShape:"sphere2";this.pointSize="pointSize"in parameters?parameters.pointSize:.02;return this};_.addPoint=function(point){let transform=Float4x4.multiply(Float4x4.scale(this.pointSize),Float4x4.translate(point));this.addChild(Node.new({transform:transform,shape:this.pointShape,children:false}));return this};_.addPoints=function(points){for(let point of points){this.addPoint(point)}};_.new=function(parameters){parameters.children=true;return Object.create(_).construct(parameters)};return _}();let Shape=function(){let _=Object.create(null);let shapes=Object.create(null);_.construct=function(name,buffers){this.name=name;let makeBuffer=function(bufferType,source,itemSize){let buffer=context.createBuffer();context.bindBuffer(bufferType,buffer);context.bufferData(bufferType,source,context.STATIC_DRAW);buffer.itemSize=itemSize;buffer.numItems=source.length/itemSize;return buffer};let HAS_NORMAL=1;let HAS_TEXTURE=2;let HAS_INDEX=4;let drawFunctionIndex=0;if("position"in buffers){this.positionBuffer=makeBuffer(context.ARRAY_BUFFER,new Float32Array(buffers.position),3)}else{}if("normal"in buffers){this.normalBuffer=makeBuffer(context.ARRAY_BUFFER,new Float32Array(buffers.normal),3);drawFunctionIndex+=HAS_NORMAL}if("texture"in buffers){this.textureBuffer=makeBuffer(context.ARRAY_BUFFER,new Float32Array(buffers.texture),2);drawFunctionIndex+=HAS_TEXTURE}if("index"in buffers){this.indexBuffer=makeBuffer(context.ELEMENT_ARRAY_BUFFER,new Uint16Array(buffers.index),1);drawFunctionIndex+=HAS_INDEX}this.draw=[function(){try{let program=Program.getCurrentProgram();if(program.useShape(this)){program.bindPositionAttribute(this.positionBuffer)}context.drawArrays(context.TRIANGLES,0,this.positionBuffer.numItems)}catch(err){}},function(){try{let program=Program.getCurrentProgram();if(program.useShape(this)){program.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer)}context.drawArrays(context.TRIANGLES,0,this.positionBuffer.numItems)}catch(err){}},function(){try{let program=Program.getCurrentProgram();if(program.useShape(this)){program.bindPositionAttribute(this.positionBuffer).bindTextureAttribute(this.textureBuffer)}context.drawArrays(context.TRIANGLES,0,this.positionBuffer.numItems)}catch(err){}},function(){try{let program=Program.getCurrentProgram();if(program.useShape(this)){program.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer).bindTextureAttribute(this.textureBuffer)}context.drawArrays(context.TRIANGLES,0,this.positionBuffer.numItems)}catch(err){}},function(){try{let program=Program.getCurrentProgram();if(program.useShape(this)){program.bindPositionAttribute(this.positionBuffer);context.bindBuffer(context.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}context.drawElements(context.TRIANGLES,this.indexBuffer.numItems,context.UNSIGNED_SHORT,0)}catch(err){}},function(){try{let program=Program.getCurrentProgram();if(program.useShape(this)){program.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer);context.bindBuffer(context.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}context.drawElements(context.TRIANGLES,this.indexBuffer.numItems,context.UNSIGNED_SHORT,0)}catch(err){}},function(){try{let program=Program.getCurrentProgram();if(program.useShape(this)){program.bindPositionAttribute(this.positionBuffer).bindTextureAttribute(this.textureBuffer);context.bindBuffer(context.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}context.drawElements(context.TRIANGLES,this.indexBuffer.numItems,context.UNSIGNED_SHORT,0)}catch(err){}},function(){try{let program=Program.getCurrentProgram();if(program.useShape(this)){program.bindPositionAttribute(this.positionBuffer).bindNormalAttribute(this.normalBuffer).bindTextureAttribute(this.textureBuffer);context.bindBuffer(context.ELEMENT_ARRAY_BUFFER,this.indexBuffer)}context.drawElements(context.TRIANGLES,this.indexBuffer.numItems,context.UNSIGNED_SHORT,0)}catch(err){}}][drawFunctionIndex];return this};_.new=function(name,buffers){return shapes[name]=Object.create(_).construct(name,buffers())};_.get=function(name){return shapes[name]};return _}();let ShapeBuilder=function(){let _=Object.create(null);_.construct=function(precision){this.precision=typeof precision!=="undefined"&&precision!=null?precision:7;this.vertexIndex=Object.create(null);this.vertices=[];this.faces=[];this.normals=[];this.texture=[];return this};_.addVertex=function(vertex){let str=Float3.str(vertex);if(str in this.vertexIndex){return this.vertexIndex[str]}else{let index=this.vertices.length;this.vertices.push(vertex);this.vertexIndex[str]=index;return index}};_.addVertexNormal=function(vertex,normal){let str=Float3.str(vertex)+Float3.str(normal);if(str in this.vertexIndex){return this.vertexIndex[str]}else{let index=this.vertices.length;this.vertices.push(vertex);this.normals.push(normal);this.vertexIndex[str]=index;return index}};_.addVertexTexture=function(vertex,texture){let str=Float3.str(vertex)+Float2.str(texture);if(str in this.vertexIndex){return this.vertexIndex[str]}else{let index=this.vertices.length;this.vertices.push(vertex);this.texture.push(texture);this.vertexIndex[str]=index;return index}};_.addVertexNormalTexture=function(vertex,normal,texture){let str=Float3.str(vertex)+Float3.str(normal)+Float2.str(texture);if(str in this.vertexIndex){return this.vertexIndex[str]}else{let index=this.vertices.length;this.vertices.push(vertex);this.normals.push(normal);this.texture.push(texture);this.vertexIndex[str]=index;return index}};_.addFace=function(face){this.faces.push(face)};_.makeBuffers=function(){let result={position:Utility.flatten(this.vertices),index:Utility.flatten(this.faces)};if(this.normals.length>0){result.normal=Utility.flatten(this.normals)}if(this.texture.length>0){result.texture=Utility.flatten(this.texture)}return result};_.makeFacets=function(){let vertex=[];let normal=[];for(let face of this.faces){let a=this.vertices[face[0]];let b=this.vertices[face[1]];let c=this.vertices[face[2]];let ab=Float3.normalize(Float3.subtract(b,a));let bc=Float3.normalize(Float3.subtract(c,b));let n=Float3.cross(ab,bc);for(let i=0;i<face.length;++i){vertex.push(this.vertices[face[i]]);normal.push(n)}}return{position:Utility.flatten(vertex),normal:Utility.flatten(normal)}};_.new=function(precision){return Object.create(ShapeBuilder).construct(precision)};return _}();let Primitive=function(){let _=Object.create(null);_.getShapeBuilder=function(){};_.makeFromBuilder=function(name,builder){name=typeof name!=="undefined"&&name!=null?name:this.name;return Shape.new(name,function(){return builder.makeFacets()})};_.make=function(name){let builder=this.getShapeBuilder();return this.makeFromBuilder(name,builder)};return _}();let Tetrahedron=function(){let _=Object.create(Primitive);_.name="tetrahedron";_.getShapeBuilder=function(){let builder=ShapeBuilder.new();builder.addVertex([1,1,1]);builder.addVertex([-1,1,-1]);builder.addVertex([-1,-1,1]);builder.addVertex([1,-1,-1]);builder.addFace([0,1,2]);builder.addFace([1,3,2]);builder.addFace([2,3,0]);builder.addFace([3,1,0]);return builder};return _}();let Hexahedron=function(){let _=Object.create(Primitive);_.name="cube";_.getShapeBuilder=function(){let builder=ShapeBuilder.new();builder.addVertex([-1,-1,-1]);builder.addVertex([-1,1,-1]);builder.addVertex([1,1,-1]);builder.addVertex([1,-1,-1]);builder.addVertex([-1,-1,1]);builder.addVertex([-1,1,1]);builder.addVertex([1,1,1]);builder.addVertex([1,-1,1]);builder.addFace([0,1,2,0,2,3]);builder.addFace([7,6,5,7,5,4]);builder.addFace([1,5,6,1,6,2]);builder.addFace([4,0,3,4,3,7]);builder.addFace([4,5,1,4,1,0]);builder.addFace([3,2,6,3,6,7]);return builder};return _}();let Octahedron=function(){let _=Object.create(Primitive);_.name="octahedron";_.getShapeBuilder=function(){let builder=ShapeBuilder.new();builder.addVertex([0,1,0]);builder.addVertex([1,0,0]);builder.addVertex([0,0,1]);builder.addVertex([-1,0,0]);builder.addVertex([0,0,-1]);builder.addVertex([0,-1,0]);builder.addFace([0,2,1]);builder.addFace([0,3,2]);builder.addFace([0,4,3]);builder.addFace([0,1,4]);builder.addFace([5,1,2]);builder.addFace([5,2,3]);builder.addFace([5,3,4]);builder.addFace([5,4,1]);return builder};return _}();let Icosahedron=function(){let _=Object.create(Primitive);_.name="icosahedron";_.getShapeBuilder=function(){let builder=ShapeBuilder.new();let t=(1+Math.sqrt(5))/2;let s=1/t;t=1;builder.addVertex([-s,t,0]);builder.addVertex([s,t,0]);builder.addVertex([-s,-t,0]);builder.addVertex([s,-t,0]);builder.addVertex([0,-s,t]);builder.addVertex([0,s,t]);builder.addVertex([0,-s,-t]);builder.addVertex([0,s,-t]);builder.addVertex([t,0,-s]);builder.addVertex([t,0,s]);builder.addVertex([-t,0,-s]);builder.addVertex([-t,0,s]);builder.addFace([0,11,5]);builder.addFace([0,5,1]);builder.addFace([0,1,7]);builder.addFace([0,7,10]);builder.addFace([0,10,11]);builder.addFace([1,5,9]);builder.addFace([5,11,4]);builder.addFace([11,10,2]);builder.addFace([10,7,6]);builder.addFace([7,1,8]);builder.addFace([3,9,4]);builder.addFace([3,4,2]);builder.addFace([3,2,6]);builder.addFace([3,6,8]);builder.addFace([3,8,9]);builder.addFace([4,9,5]);builder.addFace([2,4,11]);builder.addFace([6,2,10]);builder.addFace([8,6,7]);builder.addFace([9,8,1]);return builder};return _}();let Square=function(){let _=Object.create(Primitive);_.name="square";_.getShapeBuilder=function(){let builder=ShapeBuilder.new();builder.addVertex([-1,-1,0]);builder.addVertex([-1,1,0]);builder.addVertex([1,1,0]);builder.addVertex([1,-1,0]);builder.addFace([2,1,3,1,0,3]);return builder};return _}();let Sphere=function(){let _=Object.create(Primitive);_.name="sphere";_.parameters={baseShapeBuilderType:Icosahedron,subdivisions:4};_.getShapeBuilder=function(){let builder=ShapeBuilder.new();let addVertex=function(vertex){return builder.addVertex(Float3.normalize(vertex))};let baseShapeBuilder=this.parameters.baseShapeBuilderType.getShapeBuilder();for(let vertex of baseShapeBuilder.vertices){addVertex(vertex)}let vertices=builder.vertices;let faces=builder.faces=baseShapeBuilder.faces;let subdivide=function(){let tri=faces.splice(0,1)[0];let v0=addVertex(Float3.add(vertices[tri[0]],vertices[tri[1]]));let v1=addVertex(Float3.add(vertices[tri[1]],vertices[tri[2]]));let v2=addVertex(Float3.add(vertices[tri[2]],vertices[tri[0]]));builder.addFace([tri[0],v0,v2]);builder.addFace([tri[1],v1,v0]);builder.addFace([tri[2],v2,v1]);builder.addFace([v0,v1,v2])};for(let j=0;j<this.parameters.subdivisions;++j){for(let i=0,faceCount=faces.length;i<faceCount;++i){subdivide()}}return builder};_.makeFromBuilder=function(name,builder){name=typeof name!=="undefined"&&name!=null?name:this.name;return Shape.new(name,function(){let buffers=builder.makeBuffers();buffers.normal=buffers.position;return buffers})};_.makeN=function(n){this.parameters.subdivisions=n;this.make(this.name+n)};return _}();let makeRevolve=function(name,outline,normal,steps,projection){let epsilon=1e-6;let last=outline.length-1;normal=Utility.defaultFunction(normal,function(){let N=[];let pushNormal=function(a,c){let ac=Float2.subtract(a,c);let acPerp=Float2.perpendicular(ac);N.push(Float2.normalize(acPerp))};if(Float2.equals(outline[0],outline[last])){for(b=0;b<length;++b){let a=outline[(b-1+last)%last];let c=outline[(b+1)%last];pushNormal(a,c)}}else{for(b=0;b<=last;++b){let a=outline[b==0?b:b-1];let c=outline[b==last?b:b+1];pushNormal(a,c)}}return N});projection=typeof projection!=="undefined"&&projection!=null?projection:function(uvY){return uvY};return Shape.new(name,function(){let builder=ShapeBuilder.new();let stepAngle=-2*Math.PI/steps;for(let i=0;i<steps;++i){let j=i+1;let iAngle=i*stepAngle,iCosAngle=Math.cos(iAngle),iSinAngle=Math.sin(iAngle);let jAngle=j%steps*stepAngle,jCosAngle=Math.cos(jAngle),jSinAngle=Math.sin(jAngle);for(let m=0;m<last;++m){let n=m+1;let vm=outline[m],nm=normal[m];let vn=outline[n],nn=normal[n];if(Float2.norm(vm,vn)>epsilon){let facetType=(vm[0]<epsilon?0:2)+(vn[0]<epsilon?0:1);switch(facetType){case 0:break;case 1:{let vim=builder.addVertexNormalTexture([0,vm[1],0],[nm[0]*iCosAngle,nm[1],nm[0]*iSinAngle],[i/steps,projection(m/last)]);let vin=builder.addVertexNormalTexture([vn[0]*iCosAngle,vn[1],vn[0]*iSinAngle],[nn[0]*iCosAngle,nn[1],nn[0]*iSinAngle],[i/steps,projection(n/last)]);let vjn=builder.addVertexNormalTexture([vn[0]*jCosAngle,vn[1],vn[0]*jSinAngle],[nn[0]*jCosAngle,nn[1],nn[0]*jSinAngle],[j/steps,projection(n/last)]);builder.addFace([vim,vin,vjn]);break}case 2:{let vim=builder.addVertexNormalTexture([vm[0]*iCosAngle,vm[1],vm[0]*iSinAngle],[nm[0]*iCosAngle,nm[1],nm[0]*iSinAngle],[i/steps,projection(m/last)]);let vjm=builder.addVertexNormalTexture([vm[0]*jCosAngle,vm[1],vm[0]*jSinAngle],[nm[0]*jCosAngle,nm[1],nm[0]*jSinAngle],[j/steps,projection(m/last)]);let vin=builder.addVertexNormalTexture([0,vn[1],0],[nn[0]*iCosAngle,nn[1],nn[0]*iSinAngle],[i/steps,projection(n/last)]);builder.addFace([vim,vin,vjm]);break}case 3:{let vim=builder.addVertexNormalTexture([vm[0]*iCosAngle,vm[1],vm[0]*iSinAngle],[nm[0]*iCosAngle,nm[1],nm[0]*iSinAngle],[i/steps,projection(m/last)]);let vin=builder.addVertexNormalTexture([vn[0]*iCosAngle,vn[1],vn[0]*iSinAngle],[nn[0]*iCosAngle,nn[1],nn[0]*iSinAngle],[i/steps,projection(n/last)]);let vjm=builder.addVertexNormalTexture([vm[0]*jCosAngle,vm[1],vm[0]*jSinAngle],[nm[0]*jCosAngle,nm[1],nm[0]*jSinAngle],[j/steps,projection(m/last)]);let vjn=builder.addVertexNormalTexture([vn[0]*jCosAngle,vn[1],vn[0]*jSinAngle],[nn[0]*jCosAngle,nn[1],nn[0]*jSinAngle],[j/steps,projection(n/last)]);builder.addFace([vjm,vim,vjn]);builder.addFace([vjn,vim,vin]);break}}}}}return builder.makeBuffers()})};let makeBall=function(name,steps){let outline=[];let normal=[];let stepAngle=Math.PI/steps;for(let i=0;i<=steps;++i){let angle=stepAngle*i;let value=Float2.fixNum([Math.sin(angle),Math.cos(angle)]);outline.push(value);normal.push(value)}return makeRevolve(name,outline,normal,steps*2,function(uvY){return uvY;let angle=Math.PI*uvY;let result=1-(Math.cos(angle)+1)/2;return result})};let Utility=function(){let _=Object.create(null);const TWO_PI=Math.PI*2;let unwind=_.unwind=function(value,cap){value-=Math.floor(value/cap)*cap;while(value>=cap){value-=cap}while(value<0){value+=cap}return value};_.unwindRadians=function(radians){return _.unwind(radians,TWO_PI)};_.unwindDegrees=function(degrees){return _.unwind(degrees,360)};_.degreesToRadians=function(degrees){return unwind(degrees/180,2)*Math.PI};_.cos=function(degrees){return Math.cos(_.degreesToRadians(degrees))};_.sin=function(degrees){return Math.sin(_.degreesToRadians(degrees))};_.tan=function(degrees){return Math.tan(_.degreesToRadians(degrees))};_.radiansToDegrees=function(radians){return unwind(radians,TWO_PI)/Math.PI*180};_.uppercase=function(string){return string[0].toUpperCase()+string.slice(1)};_.lowercase=function(string){return string[0].toLowerCase()+string.slice(1)};_.flatten=function(array){let result=[];for(let element of array){for(let value of element){result.push(value)}}return result};_.fixNum=function(number,precision){let fix=typeof precision!=="undefined"&&precision!=null?precision:7;return Number.parseFloat(number.toFixed(fix))};_.defaultValue=function(value,defaultValue){return typeof value!=="undefined"&&value!=null?value:defaultValue};_.defaultFunction=function(value,defaultFunction){return typeof value!=="undefined"&&value!=null?value:defaultFunction()};_.reverseMap=function(mapping){let reverseMapping=Object.create(null);for(let name in mapping){reverseMapping[mapping[name]]=name}return reverseMapping};return _}();let Thing=function(){let _=Object.create(null);let things=Object.create(null);_.construct=function(name,node,update){this.name=name;this.node=node;this.update=update;return this};_.new=function(name,node,update){return things[name]=Object.create(_).construct(name,node,update)};_.get=function(name){return things[name]};_.updateAll=function(time){for(let name in things){let thing=things[name];thing.update(time)}};return _}();